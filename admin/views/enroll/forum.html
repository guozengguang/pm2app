<% include ../inc/head.html%>
<div class="container-fluid">
    <div class="row">
        <div class="sidebar">
            <% include ../inc/left.html%>
        </div>
        <div class="main">
            <div>
                <div class="pull-left">
                    <ul class="list-inline">
                        <li><a href="javascript:void (0)" class="addForum"><span class="glyphicon glyphicon-plus"></span> 新建</a></li>
                    </ul>
                </div>
                <div class="pull-right">
                    <form class="form-inline search-form">
                        <div class="form-group form-group-sm">
                            <input type="text" name="forum_name_form" placeholder="名称" class="form-control">
                        </div>
                        <div class="form-group form-group-sm">
                            <input type="text" name="user_nicename" placeholder="创建人" class="form-control">
                        </div>
                        <div class="form-group form-group-sm">
                            <label for="forum_type_form" class="sr-only">方式<span>*</span></label>
                            <select class="form-control" name="forum_type_form">
                                <option value="">全部</option>
                                <option value="0">先审后发</option>
                                <option value="1">先发后审</option>
                            </select>
                        </div>
                        <div class="form-group form-group-sm">
                            <label for="forum_status_form" class="sr-only">状态<span>*</span></label>
                            <select class="form-control"  name="forum_status_form">
                                <option value="">全部</option>
                                <option value="1">开启</option>
                                <option value="0">关闭</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <span class="input-group-btn">
                                    <button type="button" class="btn btn-danger btn-sm search">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                        </div>
                    </form>
                </div>
                <div class="clearfix"></div>
            </div>
            <table class="table table-striped table-condensed">
                <thead>
                <tr>
                    <th style="width:50px">序号</th>
                    <th style="width:200px">ID</th>
                    <th style="width:80px">名称</th>
                    <th style="width:100px">创建时间</th>
                    <th style="width:80px">创建人</th>
                    <th style="width:50px">状态</th>
                    <th style="width:68px">方式</th>
                    <th style="width:95px" class="text-center">操作</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="page"></div>
        </div>
    </div>
    <!-- 新增修改模态弹出框 -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog">
        <div class="modal-header"><button class="close" type="button" data-dismiss="modal">×</button>
            <h3 id="myModalLabel">Modal header</h3>
        </div>
        <div class="modal-body"></div>
    </div>
</div>
<!--新增、修改论坛弹出框开始-->
<div class="modal fade" id="forumModal" tabindex="-1" role="dialog" aria-labelledby="forumModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="forumModalLabel">新增论坛</h4>
            </div>
            <div class="modal-body">
                <form id="forum_form">
                    <div class="form-group forum_id_div" style="display: none">
                        <label for="forum_id" class="control-label">ID:</label>
                        <span id="forum_id"></span>
                    </div>
                    <div class="form-group">
                        <label for="forum_name" class="control-label">名称:<span>*</span></label>
                        <input type="text" class="form-control" name="forum_name" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'>
                    </div>
                    <div class="form-group">
                        <label for="forum_status" class="control-label">状态:<span>*</span></label>
                        <div>
                            <label><input name="forum_status" type="radio" value="1" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 开启 </label>
                            <label><input name="forum_status" type="radio" value="0" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 关闭 </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="forum_type" class="control-label">方式:<span>*</span></label>
                        <div>
                            <label><input name="forum_type" type="radio" value="0" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 先审后发 </label>
                            <label><input name="forum_type" type="radio" value="1" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 先发后审 </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="forum_publish_authority" class="control-label">发表权限:<span>*</span></label>
                        <div>
                            <label><input name="forum_publish_authority" type="checkbox" value="-1" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 游客 </label>
                            <label><input name="forum_publish_authority" type="checkbox" value="4" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 院办老师 </label>
                            <label><input name="forum_publish_authority" type="checkbox" value="10" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 员工 </label>
                            <label><input name="forum_publish_authority" type="checkbox" value="0-1" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 正式学员 </label>
                            <label><input name="forum_publish_authority" type="checkbox" value="0-0" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 普通用户 </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="forum_reply_authority" class="control-label">回复权限:<span>*</span></label>
                        <div>
                            <label><input name="forum_reply_authority" type="checkbox" value="2" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 后台回复 </label>
                            <label><input name="forum_reply_authority" type="checkbox" value="-1" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 游客 </label>
                            <label><input name="forum_reply_authority" type="checkbox" value="4" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 院办老师 </label>
                            <label><input name="forum_reply_authority" type="checkbox" value="10" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 员工 </label>
                            <label><input name="forum_reply_authority" type="checkbox" value="0-1" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 正式学员 </label>
                            <label><input name="forum_reply_authority" type="checkbox" value="0-0" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 普通用户 </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="forum_sensitive_filter" class="control-label">敏感词过滤:<span>*</span></label>
                        <div>
                            <label><input name="forum_sensitive_filter" type="radio" value="1" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 开启 </label>
                            <label><input name="forum_sensitive_filter" type="radio" value="0" required data-bv-trigger="blur" data-bv-notempty-message='必填项目'/> 关闭 </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary sure">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!--新增、修改论坛弹出框结束-->
<script>
    $(function(){
        //验证提交(点击保存)
        $('#forum_form').bootstrapValidator().on('success.form.bv', function (e) {
            e.preventDefault();
            var $form = $(e.target);
            var validator = $form.data('bootstrapValidator');
            var data = $('#forum_form').serializeArray();
            var publishArr = [];
            var replyArr = [];
            data.forEach(function (node,index) {
                if(node.name == "forum_publish_authority"){
                    publishArr.push(node.value);
                }
                if(node.name == "forum_reply_authority"){
                    replyArr.push(node.value);
                }
            })
            _.remove(data , function(n) {//返回被删除的元素
                return n.name == "forum_publish_authority";//删除name为forum_publish_authority的元素
            });
            _.remove(data , function(n) {//返回被删除的元素
                return n.name == "forum_reply_authority";//删除name为forum_reply_authority的元素
            });
            var forum_publish_authority = publishArr.join(',')
            var forum_reply_authority = replyArr.join(',')
            data.push({name:"forum_publish_authority",value:forum_publish_authority});
            data.push({name:"forum_reply_authority",value:forum_reply_authority});
            var forum_id = $("#forum_id").text();
            var url = "/admin/enroll/forum/add";
            if(forum_id != ""){
                url = "/admin/enroll/forum/update";
                data.push({name:"forum_id",value:forum_id});
            }
            $.post(url, data, function (result) {
                if (result.code == 200) {
                    effect.success(function () {
                        location.href = '/admin/enroll/forum'
                    })
                } else {
                    effect.error(result.message)
                }
            })
        });
        //分页初始值
        var options = {
            currentPage: 1,//当前页数
            totalPages: 0,//总页数
            numberOfPages: 12,//做多显示page页
            bootstrapMajorVersion: 1,//版本
            alignment: "center",
            onPageClicked: function (e, originalEvent, type, page) {
                if (page > options.totalPages) {
                    options.currentPage = options.totalPages;
                } else {
                    options.currentPage = page;
                }
                var data=$('.search-form').serializeArray();
                data.push({name:"page",value:page});
                writeList(data)
            }
        };
        //默认加载
        writeList();
        $('.search').on('click',function(){
            var data=$('.search-form').serializeArray();
            options.currentPage=1;
            writeList(data);
        });
        //写列表ajax
        function writeList(data){
            effect.show();
            $.get('/admin/enroll/forum/forum_ajax',data,function(result){
                if(result.code==200){
                    $("table tbody").empty('');
                    $("#inittmpl")
                        .tmpl(result.message.list)
                        .appendTo("table tbody");
                    options.totalPages=result.message.pagecount;
                    if (options.totalPages > 0) {
                        $('#page').bootstrapPaginator(options);
                    } else {
                        $('#page').empty();
                    }
                    effect.hide();
                }else{
                    effect.hide();
                    effect.error('请求失败')
                }
            })
        };
    });

    /* 删除论坛 */
    $(document).on('click','.delete',function(){
        var id = $(this).data('id');
        swal({
            title: "确定删除当前论坛?",
            text: "",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            cancelButtonText:"取消",
            animation: "slide-from-top",
            closeOnConfirm: true,
            html: false
        }, function(){
            $.post('/admin/enroll/forum/delete',{
                id:id
            },function (result) {
                if(result.code==200){
                    effect.success(function(){
                        location.href = "/admin/enroll/forum";
                    })
                }else{
                    effect.error(result.message)
                }
            })
        });
    })

    //新建
    $(document).on('click','.addForum',function () {
        $("#forum_form")[0].reset();
        $("#forumModalLabel").text("新增论坛");
        $("#forum_id").text('');
        $(".forum_id_div").hide();
        $('#forumModal').modal('show');
    })

    //设置数据到修改页面
    function setDataToEdit(data) {
        $("#forum_id").text(data.forum_id);
        $(".forum_id_div").show();
        //名称
        $("input[name=forum_name]").val(data.forum_name);
        if(data.forum_status == "关闭"){
            data.forum_status = "0"
        }else if(data.forum_status == "开启") {
            data.forum_status = "1"
        }
        if(data.forum_type == "先审后发"){
            data.forum_type = "0"
        }else if(data.forum_type == "先发后审"){
            data.forum_type = "1"
        }
        //状态
        $(":radio[name='forum_status'][value='" + data.forum_status + "']").prop("checked", "checked");
        //方式
        $(":radio[name='forum_type'][value='" + data.forum_type + "']").prop("checked", "checked");
        //发表权限
        $("input[name='forum_publish_authority']").each(function(){
            var item = $(this)[0];
            data.forum_publish_authority.split(',').forEach(function (node,index) {
                if(item.value == node){
                    item.checked="checked";
                }
            })
        });
        //回复权限
        $("input[name='forum_reply_authority']").each(function(){
            var item = $(this)[0];
            data.forum_reply_authority.split(',').forEach(function (node,index) {
                if(item.value == node){
                    item.checked="checked";
                }
            })
        });
        //敏感词过滤
        $(":radio[name='forum_sensitive_filter'][value='" + data.forum_sensitive_filter + "']").prop("checked", "checked");

    }
    //修改
    $(document).on('click','.editForum',function () {
        $("#forumModalLabel").text("修改论坛");
        $("#forum_id").text($(this).data().id);
        var item = $.tmplItem(this);
        setDataToEdit(item.data);
        $('#forumModal').modal('show');
    })


    //修改开启关闭状态
    $(document).on('click','.editStatus',function () {
        var data = $(this).data();
        if(data.status == "开启"){
            data.forum_status = 0;
        }else {
            data.forum_status = 1;
        }
        delete data.status;
        $.post('/admin/enroll/forum/updateStatus',data,function(result){
            if(result.code==200){
                swal({   title: "成功",   text: "操作成功！",   timer: 3000,   showConfirmButton: false });
                location.reload();
            }else {
                swal({   title: "失败",   text: "操作失败！",   timer: 3000,   showConfirmButton: false });
            }
        })
    })
</script>
<script id="inittmpl" type="text/x-jquery-tmpl">
  <tr>
    <td>${index}</td>
    <td>${forum_id}</td>
    <td><a href="/admin/enroll/forum/forum_detail/${key}">${forum_name}</a></td>
    <td>${moment(created_at).format('YYYY-MM-DD HH:mm:ss')}</td>
    <td>${user_nicename}</td>
    <td>${forum_status}</td>
    <td>${forum_type}</td>
    <td class="text-center">
    <div class="btn-group">
      <button type="button" class="btn btn-default btn btn-xs">操作选项</button>
      <button type="button" class="btn btn-primary dropdown-toggle btn-xs" data-toggle="dropdown">
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li><a class="editForum" href="javascript:void(0)" data-id="${forum_id}" data-forum="${$data.forum_id}"> 修改</a></li>
        <li><a class="editStatus" href="javascript:void(0)" data-id="${forum_id}" data-status="${forum_status}">
            {{if forum_status == "关闭"}}
                <span>开启</span>
            {{else}}
                <span>关闭</span>
            {{else}}
            {{/if}}</a>
        </li>
        <li><a class="delete" href="javascript:void 0;" data-id="${forum_id}"> 删除</a></li>
      </ul>
    </div>
    </td>
  </tr>
</script>
<% include ../inc/footer.html%>
