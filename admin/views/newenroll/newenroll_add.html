<% include ../inc/head.html%>
<script charset="utf-8" src="/kindeditor/kindeditor.js"></script>
<script charset="utf-8" src="/kindeditor/lang/zh_CN.js"></script>
<script charset="utf-8" src="/kindeditor/index.js"></script>
<% include ../inc/editor_mode.html%>
<div ng-controller="TemplateAddController">
    <div class="container-fluid">
        <div class="row">
            <div class="sidebar">
                <% include ../inc/left.html %>
            </div>
            <div class="main">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <ul class="list-inline">
                                <li><a href="javascript:history.go(-1)"><span
                                        class="glyphicon glyphicon-chevron-left"></span>返回</a></li>
                            </ul>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading"><b>添加报名学员信息</b></div>
                            <div class="panel-body" style="padding: 15px 0">
                                <form id="new_enroll_form">
                                    <div class="col-md-3" style="padding: 0">
                                        <!--well为一个灰色的背景效果-->
                                        <div class="well">
                                            <div class="form-group form-group-sm">
                                                <label class="control-label">宣传图<span><small>建议规格1156*442</small></span></label>
                                                <div class="input-group input-group-sm">
                                                    <input type="text" name="adimg_url" placeholder="上传宣传图"
                                                           class="form-control" readonly>
                                                    <span class="input-group-btn">
                                                 <span class="btn btn-danger fileinput-button btn-sm">
                                                 <span>上传</span>
                                                 <input id="addImg" type="file" name="files[]" accept="image/*">
                                                 </span>
                                              </span>
                                                </div>
                                            </div>
                                            <div class="form-group form-group-sm">
                                                <div class="progress" style="width: 100%;">
                                                    <div class="progress-bar" style="width: 0%;">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group form-group-sm">
                                                <div class="thumbnail">
                                                    <img src="" id="thisad_img">
                                                </div>
                                            </div>

                                            <div class="form-group form-group-sm">
                                                <label class="control-label">项目类型<span>*</span></label>
                                                <select name="project_type" id="projectSelect" class="form-control"
                                                        onchange="isOtherCourse(this)">
                                                    <option value="0" selected>课程</option>
                                                    <!--<option value="1">活动</option>-->
                                                    <option value="2">其他</option>
                                                </select>
                                            </div>

                                            <div class="form-group form-group-sm" name="class_name_div">
                                                <label class="control-label">课程名称<span>*</span></label>
                                                <select name="class_name" id="courseSelect" class="form-control">
                                                    <option value="-1" selected>
                                                        --请选择课程--
                                                    </option>
                                                </select>
                                            </div>

                                            <div class="form-group form-group-sm" name="activity_name_div" hidden>
                                                <label class="control-label">活动名称<span>*</span></label>
                                                <select name="activity_name" id="activitySelect" class="form-control">
                                                    <option value="-1" selected>
                                                        --请选择活动--
                                                    </option>
                                                </select>
                                            </div>

                                            <div class="form-group form-group-sm" name="qt_jz_name" hidden>
                                                <label class="control-label">其他项目名称<span></span></label>
                                                <input type="text" name="qt_jz_name" placeholder="请输入系统中尚未存在的项目名称"
                                                       class="form-control">
                                            </div>

                                            <div class="form-group form-group-sm">
                                                <label class="control-label">简章名称</label>
                                                <input type="text" name="jz_name" placeholder="简章名称"
                                                       class="form-control" required data-bv-trigger="blur"
                                                       data-bv-notempty-message='必填项目'>
                                            </div>

                                            <!--<div class="form-group form-group-sm">-->
                                            <!--<label class="control-label">模板/类型</label>-->
                                            <!--<select name="template_typename" id="templateSelect"-->
                                            <!--class="form-control">-->
                                            <!--<option value="-1" selected>-->
                                            <!--&#45;&#45;请选择模板&#45;&#45;-->
                                            <!--</option>-->
                                            <!--</select>-->
                                            <!--</div>-->

                                        </div>
                                    </div>
                                    <div class="col-md-9" style="padding: 0 0 0 15px">
                                        <div class="panel panel-danger">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <label class="control-label"
                                                           style="padding: 0 0 0 15px"><b>【报名说明】</b></label>
                                                    <input name="isshow_in_applypage" type="checkbox"
                                                           style="width: 18px;height: 18px">在报名表页面显示
                                                    <br>

                                                    <div class="form-group form-group-sm col-md-6">
                                                        <label class="control-label">课程/活动开始时间</label>
                                                        <input type="text" name="course_begin_time" placeholder="选择开始时间"
                                                               class="form-control input_date">
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-6">
                                                        <label class="control-label">课程/活动结束时间</label>
                                                        <input type="text" name="course_end_time" placeholder="选择结束时间"
                                                               class="form-control input_date">
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-6">
                                                        <label class="control-label">报名开始时间</label>
                                                        <input type="text" name="apply_begin_time" placeholder="选择开始时间"
                                                               class="form-control input_date">
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-6">
                                                        <label class="control-label">报名结束时间</label>
                                                        <input type="text" name="apply_end_time" placeholder="选择结束时间"
                                                               class="form-control input_date">
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-12">
                                                        <label class="control-label">报名人数</label>
                                                        <input type="text" name="apply_count" placeholder="报名人数"
                                                               class="form-control">
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-12">
                                                        <label class="control-label">费用</label>
                                                        <input type="text" name="course_charge" placeholder="费用"
                                                               class="form-control">
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-12">
                                                        <label class="control-label">报名说明</label>
                                                        <textarea name="bm_hint" class="form-control"
                                                                  style="height: 120px"></textarea>
                                                    </div>
                                                    <!--template_start-->
                                                    <div style="margin-left:20px;">
                                                        <div>
                                                            <div class="pull-left">
                                                                <ul class="list-inline">
                                                                    <li onclick="addTemplate();"><a
                                                                            href="javascript:void(0)"><span
                                                                            class="glyphicon glyphicon-plus"></span>新建</a>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <table class="table table-striped table-condensed table-hover"
                                                               style="width:98%;">
                                                            <thead>
                                                            <tr>
                                                                <th style="width: 5%;text-align: center;">#</th>
                                                                <th style="width: 15%;text-align: center;">模板名称</th>
                                                                <th style="width: 15%;text-align: center">创建人</th>
                                                                <th style="width: 27%;text-align: center;">创建时间</th>
                                                                <th style="width: 45%;text-align: center;">操作</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody id="initHtml">

                                                            </tbody>
                                                        </table>
                                                        <div id="page"></div>
                                                    </div>
                                                    <!--templa_end-->
                                                    <div class="form-group form-group-sm col-md-12">
                                                        <label class="control-label">二维码URL</label>
                                                        <input type="text" name="code_url" placeholder="二维码URL"
                                                               class="form-control" value="http://www.geju.com/listname/bmname.html?id=">
                                                    </div>
                                                    <label class="control-label"
                                                           style="padding: 0 0 0 15px"><b>【报名成功页面设置】</b></b></label><br>

                                                    <div class="form-group form-group-sm col-md-12">
                                                        <label class="control-label">提示说明</label>
                                                        <textarea id="success_hint" name="success_hint" value=''
                                                                  style="width:100%;height:320px;"
                                                                  class="setEditor"></textarea>
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-12">
                                                        <label class="control-label">分院地址地图<span> </span></label>
                                                        <label class="radio-inline">
                                                            <input type="radio" name="success_isshowbranchmap" value="0"
                                                                    onchange="isHiddenBranchMap(this)"> 显示分院地址
                                                        </label>
                                                        <label class="radio-inline">
                                                            <input type="radio" name="success_isshowbranchmap" value="1"
                                                                   onchange="isHiddenBranchMap(this)">
                                                            显示非分院地址
                                                        </label>
                                                        <label class="radio-inline">
                                                            <input type="radio" name="success_isshowbranchmap" value="2" checked
                                                                   onchange="isHiddenBranchMap(this)">
                                                            不显示
                                                        </label>
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-12"
                                                         name="success_notbranchaddress" hidden>
                                                        <label class="control-label">非分院地址</label>
                                                        <input type="text" name="success_notbranchaddress"
                                                               placeholder="非分院地址" class="form-control">
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-12" name="success_jwd"
                                                         hidden>
                                                        <label class="control-label">分院经度</label>
                                                        <input type="text" name="success_longitude" placeholder="经度"
                                                               class="form-control" required data-bv-trigger="blur"
                                                               data-bv-notempty-message="必填项目">
                                                        <label class="control-label">分院纬度</label>
                                                        <input type="text" name="success_latitude" placeholder="纬度"
                                                               class="form-control" required data-bv-trigger="blur"
                                                               data-bv-notempty-message="必填项目">
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-12">
                                                        <label class="control-label">其他内容</label>
                                                        <textarea id="success_other" name="success_other" value=''
                                                                  style="width:100%;height:320px;"
                                                                  class="setEditor1"></textarea>
                                                    </div>

                                                    <div class="form-group form-group-sm col-md-12">
                                                        <button type="submit"
                                                                class="btn btn-danger btn-submit btnSubmit">提交
                                                        </button>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <!--弹出选择分院列表的框-->
                                <div class="weixinmodal">
                                    <div class="modal fade " id="myModal" tabindex="-1" role="dialog"
                                         aria-labelledby="myModalLabel"
                                         aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"><span
                                                            aria-hidden="true">&times;</span><span
                                                            class="sr-only">Close</span></button>
                                                    <h4 class="modal-title" id="myModalLabel">选择分院</h4>
                                                </div>
                                                <div class="modal-body modal-rn" style="height: 500px;overflow: scroll">

                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modal_add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h5 class="modal-title">
                        添加报名模板
                    </h5>
                </div>
                <div class="container-fluid" style="width:93%;">
                    <div class="row">
                        <div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="panel panel-default">
                                        <div class="panel-body" style="padding: 15px 0">
                                            <form id="media-form">
                                                <div class="col-md-12 col-sm-12" style="padding: 0 0 0 15px">
                                                    <div class="panel panel-danger">
                                                        <div class="panel-body">
                                                            <div class="row">
                                                                <div class="form-group col-md-12 col-sm-12">
                                                                    <label class="control-label">报名模板名称<span>*</span></label>
                                                                    <input ng-model="data.name" type="text"
                                                                           name="mb_name"
                                                                           placeholder="报名模板名称" class="form-control"
                                                                           required
                                                                           data-bv-trigger="blur"
                                                                           data-bv-notempty-message="必填项目">
                                                                </div>
                                                                <div class="form-group col-md-12 col-sm-12">
                                                                    <div class="">
                                                                        <button ng-click="save(data, 0)" type="submit"
                                                                                class="btn btn-success btn-submit">
                                                                            保存基本信息
                                                                        </button>
                                                                        <span class="help-block pull-right">保存后可添加题目</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="panel panel-default">
                                        <div class="panel-body" style="padding: 15px 0">
                                            <!--二级项目开始-->
                                            <div ng-repeat="level_2 in data.children" class="col-md-12 col-sm-12"
                                                 style="padding: 0 0 0 15px">
                                                <div class="panel panel-danger">
                                                    <div class="panel-body">
                                                        <div class="row">
                                                            <div class="form-group col-md-10 col-sm-9">
                                                                <label class="control-label">题目名称<span>*</span></label>
                                                                <input ng-model="level_2.name" type="text"
                                                                       name="item_name"
                                                                       placeholder="题目名称"
                                                                       class="form-control" required
                                                                       data-bv-trigger="blur"
                                                                       data-bv-notempty-message="必填项目">
                                                            </div>
                                                            <div class="form-group col-md-2 col-sm-3">
                                                                <label class="control-label">题目排序<span>*</span></label>
                                                                <input ng-model="level_2.sort" type="text"
                                                                       name="item_name"
                                                                       placeholder="题目排序"
                                                                       class="form-control" required
                                                                       data-bv-trigger="blur"
                                                                       data-bv-notempty-message="必填项目">
                                                            </div>
                                                            <div class="form-group col-md-12 col-sm-12">
                                                                <label class="control-label">key<span>*</span></label>
                                                                <select ng-model="level_2.key" name="key"
                                                                        placeholder="key"
                                                                        class="form-control" required
                                                                        data-bv-trigger="blur"
                                                                        data-bv-notempty-message="必填项目" ng-click="selectChange($event);">
                                                                    <option value="{{x.key}}" ng-repeat="x in keys">
                                                                        {{x.key}}
                                                                    </option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group col-md-12 col-sm-12" ng-if="level_2.key == 'other'">
                                                                <input  type="text" ng-model="level_2.other_key" class="form-control"/>
                                                            </div>
                                                            <div class="form-group col-md-12 col-sm-12">
                                                                <label class="control-label">是否必填<span>*</span></label>
                                                                <div>
                                                                    <form>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.property"
                                                                                   type="radio"
                                                                                   name="property" value="required">必填
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.property"
                                                                                   type="radio"
                                                                                   name="property" value="">选填
                                                                        </label>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                            <div class="form-group col-md-6 col-sm-12">
                                                                <label class="control-label">报名项类型<span>*</span></label>
                                                                <div>
                                                                    <form>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="1" class="level3_type"
                                                                                   checked="checked"
                                                                                   ng-click="changetype($event,level_2.children,data)">
                                                                            单选
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="2" class="level3_type"
                                                                                   ng-click="changetype($event,level_2.children,data)">
                                                                            多选
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="3" class="level3_type"
                                                                                   ng-click="changetype($event,level_2.children,data)">
                                                                            文本输入
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="4" class="level3_type"
                                                                                   ng-click="changetype($event,level_2.children,data)">多行文本输入
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="5" class="level3_type"
                                                                                   ng-click="changetype($event,level_2.children,data)">视频
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="6" class="level3_type"
                                                                                   ng-click="changetype($event,level_2.children,data)">
                                                                            评分
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="7" class="level3_type"
                                                                                   ng-click="changetype($event,level_2.children,data)">省份-城市-分院
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="8" class="level3_type"
                                                                                   ng-click="changetype($event,level_2.children,data)">省份-城市-详细地址
                                                                        </label>
                                                                        <label class="radio-inline">
                                                                            <input ng-model="level_2.method"
                                                                                   type="radio" name="method"
                                                                                   value="9" class="level3_type"
                                                                                   ng-click="changetype($event,level_2.children,data)">图片
                                                                        </label>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                            <div ng-if="level_2.method==6"
                                                                 class="form-group col-md-6 col-sm-12">
                                                                <label class="control-label">设置分级<span>*</span></label>
                                                                <div>
                                                                    <input ng-model="level_2.score" type="text"
                                                                           name="item_name"
                                                                           placeholder="分级"
                                                                           class="form-control" data-bv-trigger="blur"
                                                                           data-bv-notempty-message="必填项目">
                                                                </div>
                                                            </div>
                                                            <div ng-if="level_2.method==9"
                                                                 class="form-group col-md-6 col-sm-12">
                                                                <label class="control-label">图片数量<span>*</span></label>
                                                                <div>
                                                                    <input ng-model="level_2.imgcount" type="text"
                                                                           name="item_name"
                                                                           placeholder="图片数量"
                                                                           class="form-control" data-bv-trigger="blur"
                                                                           data-bv-notempty-message="必填项目">
                                                                </div>
                                                            </div>
                                                            <div class="form-group col-md-12 col-sm-12">
                                                                <div class="">
                                                                    <button ng-click="save(level_2,data.id)"
                                                                            class="btn btn-success btn-submit">
                                                                        保存题目信息
                                                                    </button>
                                                                    <button ng-click="del_item(data.children,level_2)"
                                                                            type="submit"
                                                                            class="btn btn-danger btn-submit pull-right">
                                                                        删除题目信息
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div ng-if="level_2.method!=3 &&level_2.method!=4 &&level_2.method!=5 && level_2.method!=7 && level_2.method!=8 && level_2.method!=9"
                                                                 class="form-group col-md-12 col-sm-12">
                                                                <label class="control-label">
                                                                    排序
                                                                </label>
                                                                <button ng-disabled="!level_2.id || level_2.method == 6"
                                                                        ng-click="add_level_3(level_2)"
                                                                        class="search_button btn btn-info btn-sm pull-right"
                                                                        type="button">
                                                                    添加
                                                                </button>
                                                            </div>
                                                            <!--三级项目开始-->
                                                            <div class="form-group col-md-12 col-sm-12">
                                                                <div ng-repeat="level_3 in level_2.children"
                                                                     class="input-group row"
                                                                     style="margin-bottom: 10px;width: 100%">
                                                                    <div class="form-group col-md-1 col-sm-2">
                                                                        <input ng-model="level_3.sort" type="text"
                                                                               name="item_name"
                                                                               placeholder="排序"
                                                                               class="form-control"
                                                                               required data-bv-trigger="blur"
                                                                               data-bv-notempty-message="必填项目">
                                                                    </div>
                                                                    <div class="form-group col-md-9 col-sm-7">
                                                                        <input ng-model="level_3.name" name="reference"
                                                                               type="text"
                                                                               class="form-control"
                                                                               placeholder="标题">
                                                                    </div>
                                                                    <div class="form-group col-md-2 col-sm-3">
                                                            <span class="input-group-btn">
                                                                <!--<button ng-click="save(level_3,data.id+','+level_2.id)"-->
                                                                <!--class="search_button btn btn-success"-->
                                                                <!--type="button">保存</button>-->
                                                                <button ng-click="del_item(level_2.children,level_3)"
                                                                        class="search_button btn btn-danger"
                                                                        type="button">删除</button>
                                                            </span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="form-group col-md-12 col-sm-12">
                                                            <span class="input-group-btn">
                                                                <button ng-if="((level_2.method==1||level_2.method==2)&&(level_2.children&&level_2.id))||isAddLevel_3"
                                                                        ng-click="save(level3_Dics,data.id+','+level_2.id)"
                                                                        class="search_button btn btn-success"
                                                                        type="button">保存</button>
                                                            </span>
                                                            </div>
                                                            <!--三级项目结束-->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!--二级项目结束-->
                                            <div class="col-md-12 col-sm-12" style="padding:0 0 0 15px">
                                                <button ng-disabled="!data.id" ng-click="add_level_2(data)"
                                                        type="button"
                                                        class="btn btn-info btn-submit">
                                                    添加题目
                                                </button>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--报名模板-->
<script id="inittmpl" type="text/x-jquery-tmpl">
<tr>
  <td style="text-align: center;"><input data-id="${id}" type="radio" name="template_typename" class="template_typename"/></td>
  <td style="text-align: center;">${name}</td>
  <td style="text-align: center;">${operator}</td>
  <td style="text-align: center;">${createdAt}</td>
  <td style="text-align: center;">
     <span class="btn-group">
        <a href="javascript:void(0)"><span data-id="${id}" class="edit label label-primary editTemplate">修改</span></a>
        <a href="#" ><span data-id="${id}" class="del label label-primary">删除</span></a>
        <a href="#" ><span data-id="${id}" class="copy label label-primary">复制该模板</span></a>
     </span>
  </td>
</tr>


</script>
<!--报名模板js-->
<script>
    $(function () {
        //分页初始值
        var options = {
            currentPage: 1,//当前页数
            totalPages: 0,//总页数
            numberOfPages: 12,//最多显示page页
            bootstrapMajorVersion: 1,//版本
            alignment: "center",
            onPageClicked: function (e, originalEvent, type, page) {
                if (page > options.totalPages) {
                    options.currentPage = options.totalPages;
                } else {
                    options.currentPage = page;
                }
                writeList({
                    page: page
                })
            }
        };
        //默认加载
        writeList();
        /*当modal关闭时刷新模板数据*/
        $('#modal_add').on('hide.bs.modal', function () {
            writeList();
        })
        //写列表ajax
        function writeList(data) {
            $.get('/admin/newenroll/template_list', data, function (result) {
                if (result.code == 200) {
                    var list = result.result.rows;
                    var count = result.result.count;
                    $("table tbody").empty('');
                    $.each(list, function (i, v) {
                        v.createdAt = moment(v.createdAt).format('YYYY年MM月DD日 HH:mm:ss');
                    });
                    $("#inittmpl").tmpl(list).appendTo("table tbody");
                    options.totalPages = Math.ceil(count / 12);
                    if (options.totalPages > 0) {
                        $("#page").bootstrapPaginator(options);
                    } else {
                        $("#page").empty();
                    }
                } else {
                }
            });
        }

        //删除
        $(document).on('click', '.del', function () {
            var id = $(this).data("id");
            swal({
                title: "确定删除 " + name + " ?",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "确定",
                cancelButtonText: "取消",
                animation: "slide-from-top",
                closeOnConfirm: true,
                html: false
            }, function () {
                $.post('/admin/newenroll/delete_template', {
                    id: id
                }, function (result) {
                    if (result.code == 200) {
                        writeList();
                    } else {
                        swal("删除失败", result.message, "warning");
                    }
                })
            })
        });

        //复制模板
        $(document).on('click', '.copy', function () {
            var id = $(this).data("id");
            $.ajax({
                url: "/newenroll/template_copy",
                dataType: "json",
                async: false,
                data: {id: id},
                type: "GET",
                success: function (res) {
                    if (res.code == 200) {
                        var appElement = document.querySelector('[ng-controller=TemplateAddController]');
                        var $scope = angular.element(appElement).scope();
                        var id = res.message.returnId;
                        console.log(id)
                        $scope.keys = [
                            {"key": "name"},
                            {"key": "age"},
                            {"key": "phone"},
                            {"key": "sex"},
                            {"key": "company"},
                            {"key": "position"},
                            {"key": "classroom"},
                            {"key": "image"},
                            {"key": "vedio"},
                            {"key": "topic"},
                            {"key": "score"},
                            {"key": "hobby"},
                            {"key": "qq"},
                            {"key": "weixin"},
                            {"key": "hangye"},
                            {"key": "weibo"},
                            {"key": "code"},
                            {"key":"other"}
                        ]
                        $("#modal_add").modal('show');
                        $scope.initModel(id);
                    }
                }
            });
        });
    });
</script>
<script>

    //判断是否是选择其他课程 如何是就显示输入其他课程的输入框
    function isOtherCourse(e) {
        //如果选择的是其他
        if (e.selectedOptions[0].innerHTML == "其他") {
            $("div[name='class_name_div']").hide();
            $("div[name='activity_name_div']").hide();
            $("div[name='qt_jz_name']").show();
        } else if (e.selectedOptions[0].innerHTML == "课程"){
            $("div[name='activity_name_div']").hide();
            $("div[name='qt_jz_name']").hide();
            $("div[name='class_name_div']").show();
        }else if (e.selectedOptions[0].innerHTML == "活动"){
            $("div[name='qt_jz_name']").hide();
            $("div[name='class_name_div']").hide();
            $("div[name='activity_name_div']").show();
        }
    }
    //报名成功设置区域 是否点击了显示分院地址 如果不显示就显示手动输入
    function isHiddenBranchMap(e) {
        if (e.value == "0" || e.value == "2") {
            //选了显示分院地图 就隐藏手动输入项
            $("div[name='success_notbranchaddress']").hide();
            $("div[name='success_jwd']").hide();
        } else {
            //否则就展示手动输入区域
            $("div[name='success_notbranchaddress']").show();
            $("div[name='success_jwd']").show();
        }
    }

    function initGoodList() {
        $.get("/production/list", function (result) {
            insertGoodDom($("#courseSelect"), result.result.list);
        })
    }
    function initActivity() {
        $.get("/admin/hotel/activity/newenroll/hotel_activity_list", function (result) {
//            console.log(result)
            insertActivityDom($("#activitySelect"), result.result.list);
        })
    }

    function insertActivityDom($dom, data) {
        var html = "<option value='-1' selected>--请选择活动--</option>";
        $.each(data, function (i, v) {
//            console.log(v.id,v.newenroll_id,v.title,'ssdd')
            if(v.newenroll_id == "0"){
                html += '<option value="' + v.id + '"> ' + v.title + ' </option>';
            }else{
                html += '<option disabled value="' + v.id + '"> ' + v.title + ' (已使用)</option>';
            }

        });
        $dom.html(html);
    }

    function insertGoodDom($dom, data) {
        var html = "<option value='-1' selected>--请选择课程--</option>";
        $.each(data, function (i, v) {
            html += '<option value="' + v.goodsid + '"> ' + v.goods_name + ' </option>';
        });
        $dom.html(html);
    }
    function insertTemplateDom($dom, data) {
        var html = "<option value='-1' selected>--请选择模板--</option>";
        $.each(data, function (i, v) {
            html += '<option value ="' + v.id + '">' + v.name + '</option>';
        });
        $dom.html(html);
    }

    function initTemplateList() {
        $.get("/admin/newenroll/template_list", function (result) {
            insertTemplateDom($("#templateSelect"), result.result.rows);
        })
    }

    //当点击选中某个模板后重新激活提交按钮
    $(document).on('click', '.template_typename', function () {
        $(".btnSubmit").removeAttr("disabled");
    })

    $(function () {

        //加载课程产品列表
        initGoodList();

        //加载可用活动列表
//        initActivity();

        //加载模板列表
        initTemplateList();

        //时间选择框
        $(".input_date").datetimepicker({
            lang: 'ch',
            step: 30
        });

        //图片上传
        newupload('addImg', 'adimg_url', function (err, result) {
            if (err) {
                effect.error(err);
            } else {
                $("input[name='adimg_url']").val(result.message.name);
                $("#thisad_img").attr("src", result.message.url);
            }
        });


        //验证提交
        $("#new_enroll_form").bootstrapValidator().on('success.form.bv', function (e) {
            e.preventDefault();
            var $form = $(e.target);
            //验证插件
            var validator = $form.data('bootstrapValidator');
            //富文本编辑器
            $("#success_other").val(editor[1].html());
            $("#success_hint").val(editor[0].html());
            var data = $("#new_enroll_form").serializeArray();
            var template_data = $("input[name='template_typename']:checked").data();
            if (!template_data) {
                swal("提示", "请选择模板", "warning");
                return;
            }
            _.remove(data, function (n) {//返回被删除的元素
                return n.name == "template_typename";//删除name为en_fee的元素
            });
            data.push({name: "template_typename", value: template_data.id});
            var project_type = $("#projectSelect option:selected").val();
            var course_name = "";
            var activity_id = "";
            _.remove(data, function (n) {//返回被删除的元素
                return n.name == "activity_name" || n.name == "class_name";//删除name为activity_name、class_name的元素
            });
            if(project_type == "0"){
                course_name = $("#courseSelect option:selected").val();
            }else if(project_type == "1"){
                course_name = $("#activitySelect option:selected").val();
                activity_id = $("#activitySelect option:selected").attr("value")
                data.push({name:"activity_id",value:activity_id});
            }else if(project_type == "2"){
                course_name = "-2";
            }
            data.push({name:"course_name",value:course_name});
            console.log(data,'data');
            $.post("/newenroll/newenroll_create", data, function (result) {
                if (result.code == 200) {
                    effect.success(function () {
                        location.href = "/admin/newenroll/newenroll";
                    })
                } else {
                    effect.error(result.message);
                }
            })
        });

    });

    //身份限制复选框
    function checkIdentity(e) {
        if (e.value == "学员") {
            if (e.checked) {
                //当选中了学员的时候就显示课程选择区域
                $("#course_identity_div").show();
            } else {
                $("#course_identity_div").hide();
            }
        }
    }

    //点击创建按钮弹出新增模板弹出框
    function addTemplate() {
        var appElement = document.querySelector('[ng-controller=TemplateAddController]');
        var $scope = angular.element(appElement).scope();
        $scope.keys = [
            {"key": "name"},
            {"key": "age"},
            {"key": "phone"},
            {"key": "sex"},
            {"key": "company"},
            {"key": "position"},
            {"key": "classroom"},
            {"key": "image"},
            {"key": "vedio"},
            {"key": "topic"},
            {"key": "score"},
            {"key": "hobby"},
            {"key": "qq"},
            {"key": "weixin"},
            {"key": "hangye"},
            {"key": "weibo"},
            {"key": "code"},
            {"key":"other"}
        ]
        $("#modal_add").modal('show');
        $scope.initModel('');
    }
    $(document).on('click', '.editTemplate', function () {
        var appElement = document.querySelector('[ng-controller=TemplateAddController]');
        var $scope = angular.element(appElement).scope();
        var id = $(this).data().id;
        console.log(id)
        $scope.keys = [
            {"key": "name"},
            {"key": "age"},
            {"key": "phone"},
            {"key": "sex"},
            {"key": "company"},
            {"key": "position"},
            {"key": "classroom"},
            {"key": "image"},
            {"key": "vedio"},
            {"key": "topic"},
            {"key": "score"},
            {"key": "hobby"},
            {"key": "qq"},
            {"key": "weixin"},
            {"key": "hangye"},
            {"key": "weibo"},
            {"key": "code"},
            {"key":"other"}
        ]
        $("#modal_add").modal('show');
        $scope.initModel(id);
    })
</script>
<!--新建报名模板modal-->
<!--新增报名模板js-->
<script>

    var myModule = angular.module('cms');
    myModule.service('TemplateAddService', function ($http, $location, $q, $compile) {
        this.source = function (id) {
            if (id) {
                //编辑
                return $http({
                    url: '/admin/newenroll/find_template',
                    method: 'GET',
                    params: {
                        id: id
                    }
                });
            } else {
                //添加
                return {
                    success: function (fn) {
                        fn({
                            result: {
                                name: '',
                                level: 0,
                                children: []
                            }
                        })
                    }
                }
            }
        };
        this.save = function (data) {
            return $http({
                url: '/admin/newenroll/save_template',
                method: 'POST',
                data: data
            })
        };
        this.del = function (id) {
            return $http({
                url: "/admin/newenroll/delete_template_option",
                method: "POST",
                data: {
                    id: id
                }
            })
        }
    })
        .controller('TemplateAddController', function ($scope, TemplateAddService, $compile, $element) {

            //下拉key的值
            $scope.selectChange = function (key) {
//                console.log(key.target.value)
                var selectedValue = key.target.value;
                if(selectedValue == 'other'){
                    //显示出其他选项输入框
                }
            }
            //数据模型定义
            var level3_Dics = [];
            //第二级
            var level_2 = {
                name: '',//题目名称
                key: 'name',//模板key
                other_key:'',//其他模板key值。
                property: "required",//是否必填
                method: 1,//报名项类型 1.单选 2.多选 3.文本输入 4.评分 5.省份-城市-分院 6.省份-城市-详细地址 7.图片
                level: 2,
                type: 0,
                status: 5,
                children: []
            };
            //第三级
            var level_3 = {
                name: '',
                level: 3
            }
            //初始化模型
            $scope.initModel = function (id) {
                if (!id) {
                    $scope.data = {
                        name: '',
                        level: 0,
                        children: []
                    };
                    $scope.level_2 = level_2
                    $scope.level_3 = level_3
                    $scope.$apply();//刷新model
                    return;
                }
                TemplateAddService.source(id).success(function (result) {
                    $scope.data = result.result;
                    if ($scope.data.children != undefined && $scope.data.children.length > 0) {
                        $.each($scope.data.children, function (index, value) {
                            if (value.children != undefined && value.children.length > 0) {
                                $.each(value.children, function (index, value) {
                                    level3_Dics.push(value);
                                })
                            }
                        })
                        $scope.level3_Dics = level3_Dics;
                    }

                });
            }

            //保存方法
            $scope.save = function (source, id) {
                console.log(source, id)
                //如果id==0则为第一级别 模板的名字的保存 source.length == undefined的时候是保存题目信息
                if (id == 0 || source.length == undefined) {
                    source.parent = id;
                    source.operator = $scope.operator;

                    TemplateAddService.save(source).success(function (result) {
                        swal({
                            type: 'success',
                            title: '成功',
                            text: result.message,
                            showConfirmButton: true,
                            timeout: 1000
                        });
                        var data = result.result;
                        delete data.children;
                        _.assign(source, data);
                    });
                } else {
                    //此时是保存第三级
                    $.each(source, function (index, node) {

                        if (source[index].parent == undefined) {
                            //此时是新加进来的第三级还没有parent 就赋值为参数的值
                            node.parent = id;
                        } else {
                            //此时是原来就有的第三级有parent值
                            node.parent = source[index].parent;
                        }

                        node.operator = $scope.operator;

                        TemplateAddService.save(node).success(function (result) {
                            swal({
                                type: 'success',
                                title: '成功',
                                text: result.message,
                                showConfirmButton: true,
                                timeout: 1000
                            });
                            var data = result.result;
                            delete data.children;
                            _.assign(node, data);
                        });
                    });
                }
            };

            //添加第二级
            $scope.add_level_2 = function (data) {
                if (data.children) {
                    data.children.push(angular.copy(level_2));
                } else {
                    data.children = [angular.copy(level_2)];
                }
            };
            //添加第三级
            $scope.add_level_3 = function (data) {
                if (data.children) {
                    //往数组追加元素
                    data.children.push(angular.copy(level_3));
                } else {
                    //创建数组
                    data.children = [angular.copy(level_3)]
                }
                $scope.isAddLevel_3 = true;
                //往第三级集合里添加
                if (data.children != undefined && data.children.length > 0) {
                    var level3Dic = $scope.level3_Dics;
                    //过滤重复数据
                    $scope.level3_Dics = _.union(level3Dic, data.children);
                }
            };
            //删除题目信息
            $scope.del_item = function (target, current) {
                var id = current.id;
                if (id) {
                    swal({
                        title: "确定删除 " + name + " ?",
                        text: "",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "确定",
                        cancelButtonText: "取消",
                        animation: "slide-from-top",
                        closeOnConfirm: true,
                        html: false
                    }, function () {
                        TemplateAddService.del(id).success(function () {
                            _.remove(target, function (n) {
                                return n === current;
                            })
                            //更新数据
                            $scope.level3_Dics = target;

                            if (target.length == 0) {
                                $scope.isAddLevel_3 = false;
                            }
                        });
                    });
                } else {
                    _.remove(target, function (n) {
                        return n === current;
                    })
                    //更新数据
                    $scope.level3_Dics = target;

                    if (target.length == 0) {
                        $scope.isAddLevel_3 = false;
                    }
                }
            };

            //切换题目类型
            $scope.changetype = function (event, this_children, this_data) {
                var target = event.target;
                var radios = $("input.level3_type");
                var $oldCheckedRadio = null;
                var ids = [];
                if (this_children != undefined && this_children.length > 0) {
                    $.each(this_children, function (index, value) {
                        ids.push(value.id)
                    })
                }

                swal({
                    title: "改变类型会删除该类型下关联的子类内容,你确定要改变吗？",
                    text: "",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    animation: "slide-from-top",
                    closeOnConfirm: true,
                    html: false
                }, function (res) {
                    if (res == false) {
                        //点击了取消 就还原原来的选中项
//                        $.each(radios,function (index, value) {
//                            if(value.attributes["checked"]!=undefined && value.attributes["checked"].value == "checked"){
//                                $oldCheckedRadio = value;
//                                $oldCheckedRadio.checked = true;
//                            }
//                        })
                        //导航到编辑页面
//                        location.href = "/newenroll/template_add?id="+this_data.id;
                    } else {
                        //点击确定 删除子类关联项目
                        $.each(ids, function (index, value) {
                            TemplateAddService.del(value).success(function () {
                                _.remove(this_children, function (n) {
                                    return n.id === value;
                                })
                                //更新数据
                                $scope.level3_Dics = this_children;
                            });
                        })
                    }
                });
            };

            //当前操作用户
            $scope.operator = decodeURIComponent("admin");
        })

</script>
<% include ../inc/footer.html %>