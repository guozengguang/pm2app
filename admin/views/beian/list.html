<% include ../inc/head.html%>
<div class="container-fluid">
  <div class="row">
    <div class="sidebar">
      <% include ../inc/left.html%>
    </div>
    <div class="main">
      <div>
        <div class="pull-left">
          <font size="3" face="arial" color="black">正式学员：<span id="formalCount"></span>人</font>&nbsp;
          <font size="3" face="arial" color="black">报备学员：<span id="reportCount"></span>人</font>&nbsp;
          <!--<font size="3" face="arial" color="black">报名学员：<span id="enrollCount"></span>人</font>&nbsp;-->
        </div>
        <div class="pull-right">
          <form class="form-inline search-form">
            <div class="input-group">
              <select  class="form-control input-sm" name="myPayStatus">
                <option value="">全部学员</option>
                <option value="0">未缴费</option>
                <option value="1">缴费</option>
              </select>
            </div>
            <div class="input-group">
              <select  class="form-control input-sm" name="status">
                <option value="">全部学员</option>
                <option value="1">正式学员</option>
                <option value="2">意向学员</option>
                <option value="3">报备学员</option>
                <option value="4">报备即将失效</option>
                <option value="5">报备失效</option>
              </select>
            </div>
            <div class="input-group">
              <input type="text" name="phone" placeholder="学员手机号或姓名" class="form-control input-sm">
              <span class="input-group-btn">
                <button type="button" class="btn btn-danger btn-sm search">
                  <span class="glyphicon glyphicon-search"></span>
                </button>
              </span>
            </div>
          </form>
        </div>
        <div class="clearfix"></div>
      </div>
      <table class="table table-striped table-condensed">
        <thead>
        <tr>
          <!--<th style="width:10px">#</th>-->
          <th style="width: 7%;">学员姓名</th>
          <th>学员电话</th>
          <!--<th style="width:100px">身份证</th>-->
          <!--<th style="width:100px">渠道来源</th>-->
          <th>推荐人姓名</th>
          <!--<th style="width:100px">公司</th>-->
          <!--<th style="width:100px">公司职位</th>-->
          <th>所报课程</th>
          <!--<th style="width:100px">意向分院</th>-->
          <th>时间</th>
          <th>缴费状态</th>
          <th>学员状态</th>
          <th>归属招生老师</th>
          <th style="text-align: -webkit-center;">操作</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <div id="page"></div>
    </div>
  </div>
</div>
<!--修改、详情弹出框modal-->
<div class="modal fade" id="studentModal" tabindex="-1" role="dialog" aria-labelledby="studentModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="studentModalLabel">修改报备学员信息</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" role="form">
            <fieldset>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="m_name">学员姓名 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="m_name" name="m_name" placeholder="学员姓名"/>
                </div>
                <label class="col-sm-2 control-label" for="m_phone">学员电话 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="m_phone" name="m_phone" placeholder="学员电话"/>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="goods_name">所报课程 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="goods_name" name="goods_name" placeholder="所报课程"/>
                </div>
                <label class="col-sm-2 control-label" for="classroom_name">所属分院 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="classroom_name" name="classroom_name" placeholder="所属分院"/>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="goods_name">报备时间 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="en_time" name="en_time" placeholder="报备时间"/>
                </div>
                <label class="col-sm-2 control-label" for="m_company">公司名称 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="m_company" name="m_company" placeholder="公司名称"/>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="m_card">身份证号 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="m_card" name="m_card" placeholder="身份证号"/>
                </div>
                <label class="col-sm-2 control-label" for="m_position">公司职务 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="m_position" name="m_position" placeholder="公司职务"/>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="statusDesc">学员状态 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="statusDesc" name="statusDesc" placeholder="学员状态"/>
                </div>
                <label class="col-sm-2 control-label" for="en_reference">推荐人姓名 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="en_reference" name="en_reference" placeholder="推荐人姓名"/>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="clerk">招生老师归属 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="clerk" name="clerk" placeholder="招生老师归属"/>
                </div>
                <label class="col-sm-2 control-label" for="en_channel">渠道来源 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="en_channel" name="en_channel" placeholder="渠道来源"/>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="remark">备注说明 :</label>
                <div class="col-sm-4" style="margin-left: -20px;">
                  <input type="text" class="form-control" id="remark" name="remark" placeholder="备注说明"/>
                </div>
              </div>
            </fieldset>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  $(function(){
    //分页初始值
    var options = {
      currentPage: 1,//当前页数
      totalPages: 0,//总页数
      numberOfPages: 12,//做多显示page页
      bootstrapMajorVersion: 1,//版本
      alignment: "center",
      onPageClicked: function (e, originalEvent, type, page) {
        if (page > options.totalPages) {
          options.currentPage = options.totalPages;
        } else {
          options.currentPage = page;
        }
        var data=$('.search-form').serializeArray();
        data.push({name:'page',value:page})
        writeList(data)
      }
    };
    //默认加载
    function loadList(){
      var data=$('.search-form').serializeArray();
      options.currentPage=1;
      writeList(data);
    }
    writeList();
    $('.search').on('click',function(){
      loadList()
    });
    //写列表ajax
    function writeList(data){
      effect.show();
      $.get('/admin/beian/all_list',data,function(result){
        if(result.code==200){
          $("table tbody").empty('');
          $("#inittmpl")
                  .tmpl(result.message.list)
                  .appendTo("table tbody");
          options.totalPages=result.message.pagecount;
          var countArr = result.message.countArr;
          countArr.forEach(function (node,index) {
              if(node.name == "reportCount"){
                  $("#reportCount").text(node.value || 0);
              }
              if(node.name == "enrollCount"){
                  $("#enrollCount").text(node.value || 0);
              }
              if(node.name == "formalCount"){
                  $("#formalCount").text(node.value || 0);
              }
          });
          if (options.totalPages > 0) {
            $('#page').bootstrapPaginator(options);
          } else {
            $('#page').empty();
          }
          effect.hide();
        }else{
          effect.hide();
          effect.error('请求失败')
        }
      })
    };
    $(document).on('click',".setClerk",function () {
      var data=$(this).data()
      swal({
        title: "选择指派的招生老师",
        text: '<select class="form-control" id="reportRoom">\
            <%list.forEach(function(node,index){%>\
              <option value="<%=node.mid%>,<%=node.classroom%>,<%=node.m_name%>"><%=node.m_name%>(<%=node.classroom_name%>)</option>\
                      <%})%>\
            </select>',
        html: true,
        showCancelButton: true,
        cancelButtonText: "取消",
        confirmButtonText: "确认!",
        animation: "slide-from-top",
      },function(){
        var info=$("#reportRoom").val().split(',')
        $.post('/admin/beian/set_clerk',{mid:info[0],classroom:info[1],name:info[2],uid:data.id,clerk:data.clerk,phone:data.phone,mname:data.name},function(result){
          if(result.code==200){
            swal({   title: "成功",   text: "修改归属： "+$("#reportRoom").find("option:selected").html(),   timer: 1000,   showConfirmButton: false });
            loadList()
          }else {
            swal({   title: "失败",   text: "修改失败",   timer: 1000,   showConfirmButton: false });
          }
        })
      });
    });
    $(document).on('click',".getRemark",function () {
      var data=$(this).data()
      $.get('/admin/beian/remark_list',{id:data.id,type:2},function(result){
        if(result.code==200){
          if(result.message.list.length>0){
            var text='';
            result.message.list.forEach(function (node) {
              text+='<p>提交者: 【<b>'+node.create+'</b>】 内容：【<b>'+node.content+'</b>】 </p>'
            })
            swal({
              title: "备注详情",
              text: text,
              html: true,
              showCancelButton: true,
              showConfirmButton: false,
              cancelButtonText: "取消",
              confirmButtonText: "确认!",
              animation: "slide-from-top",
            });
          }else {
            swal({   title: "信息为空",   text: "没有备注信息",   timer: 1000,   showConfirmButton: false });
          }
        }else {
          swal({   title: "错误",   text: "请求失败",   timer: 1000,   showConfirmButton: false });
        }
      })
    });
    $(document).on('click',".setClassRoom",function () {
      var data=$(this).data()
      swal({
        title: "选择变更的分院",
        text: '<select class="form-control" id="reportRoom">\
            <%calssRoom.forEach(function(node,index){%>\
              <option value="<%=node.classroom_name%>,<%=node.classroom%>"><%=node.classroom_name%></option>\
                      <%})%>\
            </select>',
        html: true,
        showCancelButton: true,
        cancelButtonText: "取消",
        confirmButtonText: "确认!",
        animation: "slide-from-top",
      },function(){
        var info=$("#reportRoom").val().split(',')
        $.post('/admin/beian/set_check_transfer',{name:info[0],classroom:info[1],uid:data.id},function(result){
          console.log(result)
          if(result.code==200){
            swal({   title: "成功",   text: result.message.message,   timer: 1000,   showConfirmButton: false });
            loadList()
          }else {
            swal({   title: "失败",   text: result.message,   timer: 1000,   showConfirmButton: false });
          }
        })
      });
    });
    //修改报备学员或者正式学员信息
    $(document).on('click','.editInfo',function () {
        var item = $.tmplItem(this);
        var data = $(this).data();
        //flag:1修改；2详情
        var url = "/admin/beian/detail/report_detail?en_uid=" + item.data.en_uid + "&flag="+data.flag + "&goodsid=" + data.goodsid + "&en_mid=" + data.mid;
        if(data.enStatus){
            console.log(data.enStatus)
            console.log($(this).text())
            url = "/admin/beian/detail/formal_detail?en_uid=" + item.data.en_uid + "&flag="+data.flag + "&goodsid=" + data.goodsid + "&en_mid=" + data.mid;
        }
        console.log(url);
        window.location.href = url;
    })
  });
</script>
<script id="inittmpl" type="text/x-jquery-tmpl">
  <tr>
    <!--<td>${index}</td>-->
    <td>
    <span style="float:left;">${m_name}</span>
    <!--<a style="float:left;" href="javascript:void(0)" data-id="${en_uid}" data-clerk="${clerk_phone}" data-name="${m_name}" data-phone="${m_phone}" class="setClerk"> <span class="label label-success">修改归属</span></a>-->
    <!--<a href="javascript:void(0)" data-id="${en_uid}" class="setClassRoom"> <span class="label label-danger"><%=branch%></span></a>-->
    <!--<a href="javascript:void(0)" data-id="${en_uid}" class="getRemark"> <span class="label label-info">备注详情</span></a>-->
    </td>
    <td>${m_phone}</td>
    <!--<td>${m_card}</td>-->
    <!--<td>${en_channel}</td>-->
    <td>${en_reference}</td>
    <!--<td>${m_company}</td>-->
    <!--<td>${m_position}</td>-->
    <td>${goods_name}</td>
    <!--<td>${classroom_name}</td>-->
    <td>${time}</td>
    <td>{{if en_pay_status==0}}未缴费{{else}}缴费{{/if}}</td>
    <td>${statusDesc}</td>
    <td>${clerk}</td>
    <td style="text-align: -webkit-center;">
      <div class="btn-group">
        <a class="btn btn-info btn btn-xs editInfo" href="javascript:void(0)" data-id="${en_uid}" data-follow-status="${en_follow_status}" data-en-status="${en_status}" data-flag="1" data-goodsid="${goodsid}" data-mid="${en_mid}"> 修改</a>
        <a class="btn btn-primary btn btn-xs editInfo" href="javascript:void(0)" data-id="${en_uid}" data-follow-status="${en_follow_status}" data-en-status="${en_status}" data-flag="2" data-goodsid="${goodsid}" data-mid="${en_mid}">详情</a>
      </div>
    </td>
  </tr>
</script>
<% include ../inc/footer.html%>
